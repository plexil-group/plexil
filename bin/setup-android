#!/bin/bash
# File: $SVNROOT/bin/setup-android
# Note: Script to setup android to run bits and piece of Plexil

#debug=
script_name=`basename $0`
android_bin_dir=/data/local
android_lib_dir=$android_bin_dir
android_plan_dir=$android_bin_dir
android_env_file=android.env
android_apk_file=ExecModuleTester-debug.apk
#android_project=plexil

function usage ()
{
cat <<EOF

Usage:      $script_name [options]

Options:    -v   := verbose output
            -l   := load $android_apk_file

Examples:   $script_name

Notes:      

EOF
exit
}

function android-env ()
{
cat <<EOF
# Android Environment
export LD_LIBRARY_PATH=$android_bin_dir
#export PATH=\$PATH:.
run-plan()
{
  script=\$1.psx
  if [ ! -e \$1.psx ] ; then script=empty.psx ; fi
  echo "./TestExec -s \$script -p \$1.plx"
  ./TestExec -s \$script -p \$1.plx
}
EOF
} > $android_env_file

if [ "$1" = "-h" ] || [ "$1" = "-help" ] || [ "$1" = "--help" ] ; then
    usage
fi

if [ "$1" = "-v" ] ; then
    verbose=1
fi

until [ -z $1 ] ;
do
    if [ "$1" = "-v" ] ; then verbose=1 ; shift ; fi
    if [ "$1" = "-l" ] ; then load_apk=1 ; shift ; fi
    if [ "$1" = "-lv" ] || [ "$1" = "-vl" ] ; then verbose=1 ; load_apk=1 ; shift ; fi
done

if [ ! -e "AndroidManifest.xml" ] ; then
    echo " "
    echo "Not in project directory (AndroidManifest.xml not found).  Giving up."
    usage
fi

# Just use ANDROID_SDK and ANDROID_NDK in the user's environemnt

if [ ! -z $ANDROID_NDK ] ; then
    ndk-build V=$verbose
fi

if [ ! -z $ANDROID_SDK ] ; then
    ant debug
fi

echo " "
echo "checking for Android emulator..."
echo " "

# see of the emulator is running
devices=`adb devices`
sanity_check=`echo $devices | awk '{ print $1 }'`
emulator=`echo $devices | awk '{ print $5 }'`
status=`echo $devices | awk '{ print $6 }'`

if [ "$sanity_check" != "List" ] ; then
    echo "Android adb server was not running when $script_name was called.  Giving up."
    echo " "
    exit -1
elif [ -z $emulator ] ; then
    echo "Android emulator not shown in list of adb devices.  Giving up."
    echo " "
    exit -1
elif [ "$status" = "offline" ] ; then
    echo "$emulator appears to be $status.  Giving up."
    echo " "
    exit -1
else
    echo "Using $emulator"
echo " "
fi

# copy the libraries and executables over

echo " "
echo "Copying libraries and executables to $emulator:$android_bin_dir"

for file in `ls libs/armeabi/*` ;
do
    echo "Copying $file"
    adb wait-for-device push $file $android_bin_dir 2> /dev/null ;
done

# copy the plans over

echo " "
echo "Copying Plexil plans and scripts to $emulator:$android_plan_dir"

for file in `ls ../plexil/examples/*.[pc][lsf][gx]` ;
do
    echo "Copying $file"
    adb push $file $android_plan_dir 2> /dev/null ;
done

# copy android.evn over
android-env
chmod +x $android_env_file
echo " "
echo "Copying android.env to $emulator:$android_bin_dir"
adb push $android_env_file $android_bin_dir 2> /dev/null
rm $android_env_file
echo " "

if [ "$load_apk" = "1" ] ; then
    echo " "
    echo "Installing $android_apk_file on $emulator"
    adb install bin/$android_apk_file
    echo " "
fi

# EOF
