;; File: $SVNROOT/examples/multi-exec/agents/cmd.pli

(plexil-plan
  (sequence "cmd"
    (variables (string "name" "cmd")
               (integer "period" 2)
               (integer "run-length" 160)
               (real-array "actual" 5)
               (boolean "debug" true))
    ;; Send the elapsed time since the last request in order to track state correctly
    (for (integer "i" 0) (>= (intvar "run-length") (intvar "i")) (+ (intvar "i") (intvar "period"))
      (sequence "get-current-state"
        (wait (intvar "period") "Wait")
        (assignment (array-element "actual" 0) 0)
        (command "print" "\n[" (stringvar "name") "] sent: get-current-state (elapsed-time: " (intvar "i") ")\n")
        (action "get-states"
          (end-condition (not (= (array-element "actual" 0) 0)))
          (command-with-return (arrayvar "actual") "get-current-state" (intvar "period")))
        (command "print" "[" (stringvar "name") "] recv: " (arrayvar "actual") "\n")
        (sequence "decel-1"
          (variables (real "kps-decel" -1.21) (real "delta"))
          (skip-condition (or (< 70036.0 (array-element "actual" 0))
                              (> 42796.0 (array-element "actual" 0))
                              (> 180.0 (array-element "actual" 2)))) ;target speed
          (assignment (realvar "delta") (* (realvar "kps-decel") (realvar "period")))
          (command "set-speed" (realvar "delta")))
        (sequence "decel-2"
          (variables (real "kps-decel" -1.1666) (real "kps-delta") (real "dps" 1.2) (real "dps-delta"))
          (skip-condition (or (<= 42796.0 (array-element "actual" 0))
                              (> 110.0 (array-element "actual" 2))))
          (assignment (realvar "kps-delta") (* (realvar "kps-decel") (realvar "period")))
          (assignment (realvar "dps-delta") (* (realvar "dps") (realvar "period")))
          (command "set-speed" (realvar "kps-delta"))
          (action "set-angle"
            (if (> 59.8 (array-element "actual" 4))
                (command "set-angle" (realvar "dps-delta")))))))
    (wait 2 "Wait")
    (action "Quit"
      (command "print" "\n[" (stringvar "name") "] sent: Quit (quitting)\n")
      (command "SendMessage" "Quit"))))

;; EOF
