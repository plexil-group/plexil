// File: plexil/examples/multi-exec/agents/timed-iteration.ple

Command pprint(...);
Real Lookup time;

Timed-iteration:
{
  Real run_start_time;
  Real period = 0.5;
  Real elapsed_time;
  Integer run_length = 10;
  Real tolerance = 0.01;
  Boolean continue = true;
  run_start_time = Lookup(time);
  periodic_execution:
  {
    Real iteration_start_time;
    RepeatCondition continue;
    // ((now - run-start-time) % period) < (2 * tolerance)
    StartCondition (((LookupOnChange(time, tolerance) - run_start_time) % period) < (2 * tolerance));
    iteration_start_time = Lookup(time);
    elapsed_time = iteration_start_time - run_start_time;
    pprint("elapsed_time: ", elapsed_time);
    Wait (2 * tolerance), tolerance;
    maybe_end_this_run:
    {
      SkipCondition elapsed_time < run_length;
      continue = false;
      pprint("Ending current run");
    }
  }
}
